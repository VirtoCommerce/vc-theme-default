{%- if settings.collection_sidebar_filters == 'facets' -%}
  {%- if collection.all_tags.size > 0 -%}
<div class="grid-uniform">
    {%- for cat_item in collection.all_tags.groups -%}
        {%- unless cat_item.empty? -%}
        <div class="grid-item small--one-half medium--one-third">
            {%- capture group_label %}{% if cat_item == 'price' %}{{ 'tags.price.label' | t }}{% else %}{{ cat_item }}{% endif %}{%- endcapture -%}
            <h3>{{ group_label | escape }}</h3>
            <ul class="advanced-filters">
                {%- for custom_tag in collection.all_tags -%}
                    {%- if custom_tag.group_label == cat_item -%}
                        {% assign tag = custom_tag %}
                        {% include 'tag-label' %}
                        {%- if current_tags[custom_tag.value].empty? -%}
                            <li class="advanced-filter active-filter" data-group="{{ cat_item }}" data-handle="{{ custom_tag.id | handleize }}">{{ tag_label | link_to_remove_tag custom_tag }}</li>
                        {%- else -%}
                             <li class="advanced-filter" data-group="{{ cat_item }}">{{ tag_label | link_to_add_tag custom_tag }}</li>
                        {%- endif -%}
                    {%- endif -%}
                {%- endfor -%}
            </ul>
        </div>
        {%- endunless -%}
    {%- endfor -%}
</div>
<script>
    $(function() {
      var currentTags = '{{ current_tags }}',
          filters = $('.advanced-filter'),
          activeTag,
          activeHandle;

      filters.each(function() {
        var el = $(this),
            group = el.data('group'),
            isActive = el.hasClass('active-filter');
      });

      filters.on('click', function(e) {
        var el = $(this),
            group = el.data('group'),
            url = el.find('a').attr('href');

        // Continue as normal if we're clicking on the active link
        if ( el.hasClass('active-filter') ) {
          return;
        }

        // Get active group link (unidentified if there isn't one)
        activeTag = $('.active-filter[data-group="'+ group +'"]');

        // If a tag from this group is already selected, remove it from the new tag's URL and continue
        if ( activeTag && activeTag.data('group') === group ) {
          e.preventDefault();
          activeHandle = activeTag.data('handle') + '+';

          // Create new URL without the currently active handle
          url = url.replace(activeHandle, '');

          window.location = url;
        }
      });
    });
</script>
  {%- endif -%}
{%- endif -%}
